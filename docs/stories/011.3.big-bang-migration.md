# Story 011.3: Big Bang Migration with Validation

## Status
Draft

## Story
**As a** Developer implementing prompt centralization,
**I want** to migrate all 7 files to use PromptLibrary in a single clean cut-over,
**so that** prompts are fully centralized, duplications are eliminated, and the system has a clean, maintainable architecture.

## Acceptance Criteria

1. All 7 files updated to use PromptLibrary:
   - summarizer.py migrated
   - gpt_deduplication.py migrated
   - german_rating_formatter.py migrated (duplicate removed)
   - filter.py migrated
   - cross_run_deduplication.py migrated
   - incremental_digest.py migrated
   - analyzer.py migrated
2. language_config.py refactored:
   - Prompt management removed
   - Language switching logic preserved
   - Works with new PromptLibrary
3. Integration tests pass for each pipeline stage
4. End-to-end pipeline test completes successfully
5. Output validation: results match pre-migration baseline
6. Migration documentation created
7. Rollback plan documented and tested

## Tasks / Subtasks

- [ ] Task 1: Create baseline for comparison (AC: 5)
  - [ ] Run full pipeline before any changes
  - [ ] Save output as baseline (rating report, logs)
  - [ ] Document current state for comparison
  - [ ] Save database state snapshot

- [ ] Task 2: Refactor language_config.py (AC: 2)
  - [ ] Remove prompt management methods
  - [ ] Keep language switching logic (get_language(), set_language())
  - [ ] Remove prompt-related functions
  - [ ] Update any imports that reference removed methods
  - [ ] Maintain backward compatibility where possible
  - [ ] Test language switching still works

- [ ] Task 3: Migrate filter.py (AC: 1)
  - [ ] Initialize PromptLibrary with LanguageConfig
  - [ ] Replace hardcoded classification prompt with prompt_lib.filtering.classification_prompt()
  - [ ] Replace Creditreform prompt builder with prompt_lib.filtering methods
  - [ ] Update all prompt-related code
  - [ ] Test filtering stage independently
  - [ ] Verify output matches baseline

- [ ] Task 4: Migrate gpt_deduplication.py (AC: 1)
  - [ ] Initialize PromptLibrary
  - [ ] Replace clustering prompt with prompt_lib.deduplication.clustering_prompt()
  - [ ] Update title comparison logic
  - [ ] Test deduplication stage independently
  - [ ] Verify clustering results match baseline

- [ ] Task 5: Migrate cross_run_deduplication.py (AC: 1)
  - [ ] Initialize PromptLibrary
  - [ ] Replace cross-run prompt with prompt_lib.deduplication.cross_run_prompt()
  - [ ] Update summary comparison logic
  - [ ] Test cross-run dedup independently
  - [ ] Verify results match baseline

- [ ] Task 6: Migrate german_rating_formatter.py (AC: 1)
  - [ ] Initialize PromptLibrary
  - [ ] Replace rating prompt with prompt_lib.formatting.rating_prompt()
  - [ ] **Remove duplicate prompt** (use PromptLibrary version)
  - [ ] Test formatting stage independently
  - [ ] Verify output matches baseline

- [ ] Task 7: Migrate summarizer.py (AC: 1)
  - [ ] Initialize PromptLibrary
  - [ ] Replace hardcoded system prompt with prompt_lib.digest.summarization_prompt()
  - [ ] Update summarization logic
  - [ ] Test summarization stage independently
  - [ ] Verify summaries match baseline quality

- [ ] Task 8: Migrate incremental_digest.py (AC: 1)
  - [ ] Initialize PromptLibrary
  - [ ] Replace language_config prompt calls with prompt_lib.digest methods
  - [ ] Update digest generation logic
  - [ ] Test digest stage independently
  - [ ] Verify digest output matches baseline

- [ ] Task 9: Migrate analyzer.py (AC: 1)
  - [ ] Initialize PromptLibrary
  - [ ] Replace language_config prompt calls with prompt_lib.analysis methods
  - [ ] Update analysis logic
  - [ ] Test analysis stage independently
  - [ ] Verify analysis output matches baseline

- [ ] Task 10: Integration testing (AC: 3, 4)
  - [ ] Run full pipeline with all migrations
  - [ ] Test each stage in sequence
  - [ ] Monitor for errors in logs
  - [ ] Check for parameter mismatches
  - [ ] Validate German/English language support
  - [ ] Test all pipeline configurations

- [ ] Task 11: Output validation (AC: 5)
  - [ ] Compare final output with baseline
  - [ ] Byte-by-byte comparison where possible
  - [ ] Verify structural correctness
  - [ ] Check for regression in quality
  - [ ] Validate all fields present
  - [ ] Document any differences

- [ ] Task 12: Documentation and rollback plan (AC: 6, 7)
  - [ ] Document migration steps
  - [ ] Create rollback procedure
  - [ ] Test rollback works
  - [ ] Update architecture documentation
  - [ ] Create migration notes
  - [ ] Document lessons learned

## Dev Notes

### Context from Epic 011

**Source Document:** docs/stories/epic-prompt-library-011-centralization.md

**Background:**
This story performs the "big bang" migration - updating all 7 files at once to use the new PromptLibrary system. The approach avoids long-term technical debt from maintaining dual systems.

**Why Big Bang:**
- Clean cut-over vs prolonged transition
- Avoids dual systems maintenance
- Consistent developer experience immediately
- Enables immediate benefits across entire pipeline

**Risk Mitigation:**
- Comprehensive testing at each stage
- Baseline comparison for validation
- Documented rollback plan
- Atomic git commit for easy revert

### Files to Migrate (7 Total)

**Source:** docs/stories/epic-prompt-library-011-centralization.md

1. **summarizer.py** - Hardcoded system prompt for summarization
2. **gpt_deduplication.py** - Clustering prompt for duplicate detection
3. **german_rating_formatter.py** - Rating prompt (REMOVE DUPLICATE)
4. **filter.py** - Classification + Creditreform prompts
5. **cross_run_deduplication.py** - Cross-run deduplication prompt
6. **incremental_digest.py** - Uses language_config (update to prompt_lib)
7. **analyzer.py** - Uses language_config (update to prompt_lib)

**Plus:**
8. **language_config.py** - Refactor to remove prompt management

### Migration Pattern

**Standard Migration for Each File:**

1. **Add PromptLibrary Import:**
```python
from news_pipeline.prompt_library import PromptLibrary
from news_pipeline.language_config import LanguageConfig
```

2. **Initialize in __init__ or setup:**
```python
class MyPipelineComponent:
    def __init__(self, db_path: str):
        self.db_path = db_path
        self.language_config = LanguageConfig("german")  # or from config
        self.prompt_lib = PromptLibrary(self.language_config)
```

3. **Replace Hardcoded Prompts:**
```python
# BEFORE:
system_prompt = """
You are a classifier...
Topic: {topic}
"""
prompt = system_prompt.format(topic=topic)

# AFTER:
prompt = self.prompt_lib.filtering.classification_prompt(topic=topic)
```

4. **Test Independently:**
```python
# Run this stage in isolation
# Verify output matches pre-migration baseline
```

### language_config.py Refactoring

**CRITICAL:** This file requires careful refactoring!

**What to KEEP:**
- Language selection logic (get_language(), set_language())
- Language-specific text formatting
- Any locale/translation functions
- Non-prompt related functionality

**What to REMOVE:**
- Prompt management methods
- Functions returning prompt templates
- Prompt-specific configuration

**Example Refactoring:**
```python
# BEFORE:
class LanguageConfig:
    def get_analysis_prompt(self):
        return self.prompts["analysis"][self.current_language]
    
    def get_language(self):
        return self.current_language

# AFTER:
class LanguageConfig:
    # REMOVED: get_analysis_prompt() - moved to PromptLibrary
    
    def get_language(self):
        return self.current_language  # KEEP THIS
```

### File-by-File Migration Details

#### 1. filter.py Migration

**Current State:**
- Hardcoded classification prompt
- Dynamic Creditreform prompt builder

**Migration Steps:**
```python
# 1. Add imports
from news_pipeline.prompt_library import PromptLibrary

# 2. Initialize in __init__
def __init__(self, config_path: str):
    # existing code...
    self.prompt_lib = PromptLibrary(self.language_config)

# 3. Replace prompt usage
# BEFORE:
classification_prompt = f"""
Classify article for topic {topic}...
"""

# AFTER:
classification_prompt = self.prompt_lib.filtering.classification_prompt(
    topic=topic,
    article_text=article.content
)
```

**Testing:**
- Run filter on sample articles
- Verify classification results match baseline
- Check both German and English

#### 2. gpt_deduplication.py Migration

**Current State:**
- Clustering prompt for title comparison

**Migration Steps:**
```python
# Initialize PromptLibrary
self.prompt_lib = PromptLibrary(self.language_config)

# Replace clustering prompt
# BEFORE:
clustering_prompt = """
Compare these titles and identify duplicates...
"""

# AFTER:
clustering_prompt = self.prompt_lib.deduplication.clustering_prompt(
    titles=title_list
)
```

**Testing:**
- Run deduplication on sample articles
- Verify clusters match baseline
- Check duplicate identification accuracy

#### 3. cross_run_deduplication.py Migration

**Current State:**
- Cross-run comparison prompt

**Migration Steps:**
```python
# Similar to gpt_deduplication
self.prompt_lib = PromptLibrary(self.language_config)

# Replace cross-run prompt
cross_run_prompt = self.prompt_lib.deduplication.cross_run_prompt(
    new_summary=new_article_summary,
    previous_summaries=previous_signatures
)
```

**Testing:**
- Simulate multiple runs
- Verify topic deduplication works
- Check false positive/negative rates

#### 4. german_rating_formatter.py Migration

**Current State:**
- Rating prompt (DUPLICATES language_config)

**Critical Step:**
**REMOVE THE DUPLICATE PROMPT** from this file!

**Migration Steps:**
```python
# Initialize PromptLibrary
self.prompt_lib = PromptLibrary(self.language_config)

# Replace rating prompt
# BEFORE (DUPLICATE - REMOVE THIS):
rating_prompt = """
Generate rating for article...
"""

# AFTER (Use PromptLibrary):
rating_prompt = self.prompt_lib.formatting.rating_prompt(
    article=article_data
)
```

**Testing:**
- Verify ratings match baseline
- Confirm no quality degradation
- Check German output format

#### 5. summarizer.py Migration

**Current State:**
- Hardcoded summarization system prompt

**Migration Steps:**
```python
self.prompt_lib = PromptLibrary(self.language_config)

# Replace summarization prompt
summarization_prompt = self.prompt_lib.digest.summarization_prompt(
    article=article_content,
    max_length=150
)
```

**Testing:**
- Compare summaries quality
- Verify length constraints work
- Check key information preservation

#### 6. incremental_digest.py Migration

**Current State:**
- Uses language_config methods

**Migration Steps:**
```python
# Initialize PromptLibrary
self.prompt_lib = PromptLibrary(self.language_config)

# Replace language_config calls
# BEFORE:
prompt = self.language_config.get_digest_prompt(...)

# AFTER:
prompt = self.prompt_lib.digest.merge_prompt(...)
```

**Testing:**
- Test incremental updates
- Verify digest merging works
- Check state management

#### 7. analyzer.py Migration

**Current State:**
- Uses language_config methods

**Migration Steps:**
```python
self.prompt_lib = PromptLibrary(self.language_config)

# Replace language_config calls
# BEFORE:
prompt = self.language_config.get_analysis_prompt(...)

# AFTER:
prompt = self.prompt_lib.analysis.topic_analysis_prompt(...)
```

**Testing:**
- Test topic analysis
- Verify meta-analysis works
- Check digest generation

### Baseline Creation

**Before ANY Migration:**

```bash
# 1. Run full pipeline
python news_analyzer.py

# 2. Save outputs
cp rating_reports/latest.md baseline_output.md
cp news.db baseline.db

# 3. Save logs
cp logs/latest.log baseline.log

# 4. Document state
echo "Baseline created $(date)" > baseline_timestamp.txt
```

### Testing Strategy

**Source:** docs/architecture.md - Testing Strategy section

**Three Levels of Testing:**

1. **Unit Tests (Per File):**
```python
def test_filter_migration():
    """Test filter.py uses PromptLibrary correctly."""
    filter = AIFilter(config_path)
    # Test prompt retrieval
    prompt = filter.prompt_lib.filtering.classification_prompt(topic="test")
    assert prompt is not None
    assert "test" in prompt

def test_language_config_refactored():
    """Test language_config no longer has prompt methods."""
    lang_config = LanguageConfig("german")
    # Should NOT have prompt methods
    assert not hasattr(lang_config, "get_analysis_prompt")
    # SHOULD have language methods
    assert hasattr(lang_config, "get_language")
```

2. **Integration Tests (Per Stage):**
```python
def test_filtering_stage_integration():
    """Test filtering stage works end-to-end."""
    # Run filtering on test articles
    results = run_filtering_stage(test_articles)
    # Compare with baseline
    assert results == baseline_results

def test_deduplication_stage_integration():
    """Test deduplication works after migration."""
    # Run deduplication
    clusters = run_deduplication_stage(test_articles)
    # Verify clustering matches baseline
    assert clusters == baseline_clusters
```

3. **End-to-End Pipeline Test:**
```python
def test_full_pipeline_migration():
    """Test complete pipeline with all migrations."""
    # Run full pipeline
    output = run_full_pipeline(test_date)
    
    # Load baseline
    baseline = load_baseline_output()
    
    # Compare (allowing for timestamps)
    assert output_matches_baseline(output, baseline)
```

### Output Validation Strategy

**Comparison Approach:**

1. **Structural Comparison:**
```python
# Check all expected sections present
assert "## Bonit√§tsbewertungen" in output
assert all sections present
```

2. **Content Quality Comparison:**
```python
# Compare key metrics
baseline_article_count = count_articles(baseline)
current_article_count = count_articles(output)
assert abs(baseline_article_count - current_article_count) <= 2  # Allow small variance
```

3. **Byte-by-Byte (Where Possible):**
```python
# For deterministic sections
baseline_section = extract_section(baseline, "ratings")
current_section = extract_section(output, "ratings")
# Compare ignoring timestamps
assert normalize_timestamps(baseline_section) == normalize_timestamps(current_section)
```

### Rollback Plan

**If Migration Fails:**

```bash
# 1. Revert code changes
git reset --hard HEAD~1  # Or specific commit before migration

# 2. Restore database if needed
cp baseline.db news.db

# 3. Verify system works
python news_analyzer.py

# 4. Document issue
echo "Rollback performed due to: [reason]" >> rollback_log.txt
```

**Rollback Testing:**
```bash
# Test rollback BEFORE migration
# 1. Create test branch
git checkout -b test-rollback

# 2. Make dummy change
echo "test" >> test_file.txt
git add test_file.txt
git commit -m "Test change"

# 3. Practice rollback
git reset --hard HEAD~1

# 4. Verify works
# 5. Return to migration branch
git checkout migration-branch
```

### Risk Mitigation

**Potential Issues and Mitigations:**

1. **Parameter Mismatches:**
   - Risk: Prompt parameters don't match expectations
   - Mitigation: Test each file independently first
   - Detection: Watch for KeyError or format() errors

2. **Language Switching Breaks:**
   - Risk: German/English switching stops working
   - Mitigation: Test both languages explicitly
   - Detection: Output in wrong language

3. **Performance Degradation:**
   - Risk: YAML loading slows pipeline
   - Mitigation: PromptLibrary caching (from Story 1)
   - Detection: Monitor execution time

4. **Quality Regression:**
   - Risk: Output quality degrades
   - Mitigation: Baseline comparison
   - Detection: Review output manually

### Monitoring During Migration

**Watch For:**

```python
# 1. Error logs
grep -i "error\|exception" logs/migration.log

# 2. Missing prompts
grep -i "KeyError\|not found" logs/migration.log

# 3. Parameter issues
grep -i "format\|parameter" logs/migration.log

# 4. Language issues
grep -i "language\|deutsch\|english" logs/migration.log
```

### Dependencies

**From Previous Stories:**
- Story 011.1 (PromptLibrary Architecture) MUST be complete and tested
- Story 011.2 (YAML Extraction) MUST be complete with all prompts documented

**Critical:**
Cannot proceed without working PromptLibrary and complete YAML files!

### Testing

**Testing Standards:**
**Source:** docs/architecture.md - Testing Strategy section

**Test Files:**
- `scripts/test_migration.py` - Main migration tests
- `scripts/test_prompt_lib_integration.py` - Integration tests

**Test Coverage:**
- All 7 migrated files have unit tests
- Each pipeline stage has integration test
- Full pipeline has end-to-end test
- Rollback procedure tested

### Completion Criteria

**Before Marking Complete:**
- [ ] All 7 files successfully migrated
- [ ] language_config.py refactored (prompt management removed)
- [ ] Duplicate prompt removed from german_rating_formatter.py
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] End-to-end pipeline test passes
- [ ] Output matches baseline (within acceptable variance)
- [ ] Both German and English tested
- [ ] Migration documentation created
- [ ] Rollback plan documented and tested
- [ ] Architecture documentation updated
- [ ] Change Log updated
- [ ] Epic 011 complete!

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Initial story draft created from Epic 011 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
*To be filled by Dev Agent during implementation*

### Debug Log References
*To be filled by Dev Agent during implementation*

### Completion Notes List
*To be filled by Dev Agent during implementation*

### File List
*To be filled by Dev Agent during implementation*

## QA Results
*This section will be populated by QA Agent after story implementation*
