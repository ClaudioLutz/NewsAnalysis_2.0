# Story 011.6: Complete Remaining File Migrations

**Story ID:** 011.6  
**Epic:** 011 - Hybrid Prompt Architecture Migration  
**Created:** 2025-10-05  
**Status:** Blocked by 011.5  
**Priority:** High  
**Effort:** 3-5 days  
**Confidence:** 90%

---

## Story

As a developer, I need all remaining files with prompt management migrated to the hybrid architecture so that 90%+ of prompts are centralized and maintainable.

---

## Context

With the pattern established in Story 011.4 and proven with filter.py in Story 011.5, we can now migrate the remaining files systematically. Each file will be assessed and migrated using the appropriate approach:

- **Static prompts** â†’ Full YAML migration
- **Dynamic prompts** â†’ Fragment-based hybrid
- **No prompts** â†’ Document as "no migration needed"

---

## Acceptance Criteria

- [ ] All 5 remaining files analyzed and migrated (or documented as no-migration-needed)
- [ ] 90%+ of prompt text lives in YAML or fragments
- [ ] Full pipeline baseline comparison passes
- [ ] All tests passing
- [ ] Documentation updated
- [ ] Epic completion criteria met

---

## Files to Migrate

### File 1: analyzer.py
**Expected Complexity:** Medium (likely has dynamic prompts)  
**Estimated Effort:** 1-2 days

**Analysis:**
- Check for prompt strings
- Identify static vs dynamic parts
- Likely has analysis/rating prompts

**Migration Strategy:**
- Extract static fragments to `analysis` section in fragments.yaml
- Use fragment composition for dynamic parts
- Validate analysis output matches baseline

### File 2: deduplication.py
**Expected Complexity:** Low (probably static)  
**Estimated Effort:** 0.5 days  
**Note:** May have been done in Story 011.4 as proof-of-concept

**Analysis:**
- Deduplication prompts likely fully static
- Should be straightforward YAML migration

**Migration Strategy:**
- If not done in 011.4, extract to `deduplication` section
- Simple get_prompt() usage, no fragments needed
- Validate deduplication works correctly

### File 3: summarizer.py
**Expected Complexity:** Low (probably static)  
**Estimated Effort:** 0.5-1 day

**Analysis:**
- Summarization prompts likely fully static
- May have simple language variations

**Migration Strategy:**
- Extract to `summarization` section in prompts YAML
- Use language_config for language selection
- Validate summaries match baseline quality

### File 4: incremental_digest.py
**Expected Complexity:** Medium (might have dynamic parts)  
**Estimated Effort:** 1 day

**Analysis:**
- Digest prompts may include dynamic article lists
- Needs careful analysis of prompt structure

**Migration Strategy:**
- Identify if it references removed digest prompts
- Extract static parts to `digest` section
- Use fragments if dynamic composition needed
- Validate digest generation

### File 5: german_rating_formatter.py
**Expected Complexity:** Low (check if has prompts)  
**Estimated Effort:** 0.5 day or 0 if no prompts

**Analysis:**
- File name suggests formatting, may not have prompts
- Could just be output formatting logic

**Migration Strategy:**
- Quick analysis: does it have LLM prompts?
- If yes: extract to YAML
- If no: document as "no migration needed"

---

## Tasks

### Task 1: Analyze All Files
**Subtasks:**
- [ ] Search each file for prompt strings
- [ ] Classify: Static / Dynamic / Hybrid / No Prompts
- [ ] Document findings in migration notes
- [ ] Create migration priority order
- [ ] Update effort estimates if needed

**Analysis Template:**
```markdown
### [Filename]
- **Prompts found:** [count]
- **Type:** Static / Dynamic / Hybrid / None
- **Complexity:** Low / Medium / High
- **Migration approach:** Full YAML / Fragments / Hybrid / None
- **Dependencies:** [other files/configs]
- **Estimated effort:** [hours/days]
```

### Task 2: Migrate Files One at a Time
**For Each File:**
- [ ] Read current implementation
- [ ] Extract prompts to appropriate YAML section
- [ ] Refactor code to use PromptLibrary
- [ ] Add/update tests
- [ ] Run file-specific validation
- [ ] Commit changes (atomic commits per file)
- [ ] Move to next file

**Order Recommendation:**
1. Start with simplest (likely deduplication or summarizer)
2. Build confidence with easy wins
3. Save complex for last when pattern is clear

### Task 3: Update Documentation
**Subtasks:**
- [ ] Update `config/prompts/README.md` with new sections
- [ ] Document any special cases or patterns discovered
- [ ] Update migration_progress.md
- [ ] Add examples of each migration type
- [ ] Document lessons learned

### Task 4: Full Pipeline Integration Test
**Subtasks:**
- [ ] Run complete pipeline end-to-end
- [ ] Compare all outputs to baseline
- [ ] Verify each stage works correctly:
  - [ ] Collection
  - [ ] Filtering (from 011.5)
  - [ ] Deduplication
  - [ ] Scraping
  - [ ] Summarization
  - [ ] Analysis/Rating
  - [ ] Digest generation
- [ ] Check for any integration issues
- [ ] Verify performance is acceptable

### Task 5: Final Validation & Cleanup
**Subtasks:**
- [ ] Calculate final centralization rate (should be 90%+)
- [ ] Review all modified files for consistency
- [ ] Ensure all tests passing
- [ ] Update all documentation
- [ ] Clean up any temporary files
- [ ] Final baseline comparison
- [ ] Mark Epic 011 as complete

---

## Per-File Migration Checklist

Use this checklist for each file migrated:

```markdown
### [Filename] Migration

**Pre-Migration:**
- [ ] File analyzed
- [ ] Prompts identified and categorized
- [ ] Migration strategy decided
- [ ] Tests identified/created

**Migration:**
- [ ] Static prompts extracted to YAML
- [ ] Dynamic prompts using fragments (if needed)
- [ ] Code refactored to use PromptLibrary
- [ ] Helper methods created (if needed)
- [ ] Type hints added/updated
- [ ] Docstrings updated

**Validation:**
- [ ] Unit tests passing
- [ ] File-specific validation passing
- [ ] Output matches baseline
- [ ] No new warnings or errors
- [ ] Performance acceptable

**Documentation:**
- [ ] Migration notes updated
- [ ] Code comments added
- [ ] README updated (if needed)
- [ ] Committed with clear message
```

---

## Dev Notes

### Files to Modify
1. **news_pipeline/analyzer.py**
2. **news_pipeline/deduplication.py** (if not done in 011.4)
3. **news_pipeline/summarizer.py**
4. **news_pipeline/incremental_digest.py**
5. **news_pipeline/german_rating_formatter.py**
6. **config/prompts/fragments.yaml** (add sections as needed)
7. **config/prompts/[new files].yaml** (if needed for specific files)
8. **config/prompts/README.md** (documentation updates)

### Testing Strategy
1. **Per-file tests:** Validate each file independently
2. **Integration tests:** Full pipeline end-to-end
3. **Baseline comparison:** No behavior regressions
4. **Performance tests:** No significant slowdowns

### Success Metrics Check
Before marking complete, verify:
- [ ] Prompt Centralization Rate: 90%+ in YAML
- [ ] Maintenance Burden: <5 files to edit for changes
- [ ] Development Velocity: Prompt changes don't require code changes (static)
- [ ] Quality: Zero behavior regressions

---

## Definition of Done

- [ ] All 5 files analyzed
- [ ] All prompts migrated or documented as no-migration-needed
- [ ] 90%+ centralization rate achieved
- [ ] All tests passing
- [ ] Full pipeline validation passing
- [ ] Documentation complete
- [ ] Code reviewed
- [ ] Epic 011 acceptance criteria met
- [ ] Pattern ready for future prompt additions

---

## References

- **Epic:** `docs/stories/epic-011-hybrid-prompt-migration.md`
- **Previous:** `docs/stories/011.5.migrate-filter-hybrid.md`
- **Pattern:** `docs/stories/011.4.establish-fragment-architecture.md`
- **Analysis:** `docs/stories/011.3-elicitation-findings.md`

---

## Risk Mitigation

**Risk:** Some files more complex than estimated  
**Mitigation:**
- Start with simplest files first
- Can leave complex file for future story if needed
- 90% goal allows for some flexibility

**Risk:** Integration issues between migrated files  
**Mitigation:**
- Test integration after each file
- Keep commits atomic for easy rollback
- Full pipeline test before completion

**Risk:** Timeline slips beyond 5 days  
**Fallback:**
- Ship what's done, document remaining
- Re-prioritize based on actual complexity
- Consider splitting remaining work

**Risk:** Baseline validation fails  
**Mitigation:**
- Character-by-character prompt comparison
- Debug with small samples
- Rollback to previous working state if needed

---

## Completion Celebration ðŸŽ‰

When this story is done, Epic 011 is complete! This means:

âœ… **Prompt centralization achieved** - 90%+ of prompts in YAML  
âœ… **Maintainability improved** - Easy to update prompts  
âœ… **Pattern established** - Future prompts follow clear guidelines  
âœ… **Zero behavior regressions** - Validated against baseline  
âœ… **Clear documentation** - Next developer can understand and extend  

**Well done, team! The migration that seemed impossible is now complete!** ðŸš€

---

**Story Created:** 2025-10-05  
**Created By:** Bob (Scrum Master) ðŸƒ  
**Blocked By:** Story 011.5  
**Completes:** Epic 011
