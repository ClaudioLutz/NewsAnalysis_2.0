# Story: Update Templates for Individual Article Output

**Epic:** Cross-Run Topic Deduplication Enhancement
**Story ID:** epic-cross-run-dedup-005
**Status:** Draft
**Priority:** Medium
**Estimated Effort:** 2-3 hours
**Depends On:** epic-cross-run-dedup-004 (Pipeline integration must be complete)

## Story

As a **Report Consumer**
I need **daily digests to display individual article-link-summary pairs**
So that **I can see each unique article with its own summary instead of topic-aggregated summaries**

## Acceptance Criteria

### Template Modifications
- [ ] Modify `templates/daily_digest.md.j2` to output individual articles
- [ ] Create new template `templates/individual_article_digest.md.j2` (optional alternative)
- [ ] Each article displayed with: Title, Link, Summary, Source, Date
- [ ] Management summary at top provides overview of topics found
- [ ] German localization maintained for all text

### Output Format
- [ ] Management Summary section lists topic overview
- [ ] Individual Articles section shows article-link-summary pairs
- [ ] Each article clearly separated (markdown headers or dividers)
- [ ] Articles ordered by relevance/confidence
- [ ] Cross-run dedup statistics included in report footer

### Metadata Display
- [ ] Total unique articles count displayed
- [ ] Topics already covered count (if >0)
- [ ] Deduplication rate shown if applicable
- [ ] Run timestamp and sequence number

### Backward Compatibility
- [ ] Existing template variables still supported
- [ ] Fallback to current format if individual article data unavailable
- [ ] German rating report generation continues to work

## Dev Notes

### Reference Files
- Architecture: `docs/architecture.md` - Source Tree section (template modifications)
- Existing Template: `templates/daily_digest.md.j2`
- Pattern Reference: German formatter in `news_pipeline/german_rating_formatter.py`

### Technical Implementation Details

#### Template Modification Approach

**Option A:** Modify existing template (Recommended)
- Update `templates/daily_digest.md.j2` to handle both formats
- Use conditional logic to detect individual vs aggregated data
- Maintains single template file

**Option B:** Create new template
- Create `templates/individual_article_digest.md.j2`
- Keep old template for backward compatibility
- Modify enhanced_analyzer.py to select template based on mode

### Template Structure (Option A - Recommended)

```jinja2
# {{ data.date }} - Swiss Business News Digest

**Generated:** {{ data.generated_at }}
{% if data.cross_run_dedup_stats %}
**Run Info:** Articles processed: {{ data.cross_run_dedup_stats.articles_processed }}, 
Duplicates filtered: {{ data.cross_run_dedup_stats.duplicates_filtered }} 
({{ data.cross_run_dedup_stats.deduplication_rate }})
{% endif %}

---

## Management Summary

{{ data.executive_summary.headline }}

{{ data.executive_summary.executive_summary }}

### Key Themes
{% for theme in data.executive_summary.key_themes %}
- {{ theme }}
{% endfor %}

---

## Individual Articles

{% for topic, digest in data.topic_digests.items() %}
{% if digest.articles %}
### Topic: {{ topic | topic_name }}

{% for article in digest.articles %}
#### {{ article.title }}

**Source:** {{ article.source }} | **Date:** {{ article.published_at | datetime_format('%Y-%m-%d %H:%M') }}  
**Link:** {{ article.url }}

**Summary:**
{{ article.summary }}

---

{% endfor %}
{% endif %}
{% endfor %}

## Statistics

- **Total Unique Articles:** {{ data.cross_run_dedup_stats.articles_processed - data.cross_run_dedup_stats.duplicates_filtered }}
- **Topics Covered:** {{ data.topic_digests | length }}
{% if data.cross_run_dedup_stats.duplicates_filtered > 0 %}
- **Topics Filtered (Already Covered):** {{ data.cross_run_dedup_stats.duplicates_filtered }}
{% endif %}

---

*Generated by NewsAnalysis_2.0 Pipeline with Cross-Run Topic Deduplication*
```

### Data Structure Changes in enhanced_analyzer.py

Modify digest generation to include individual articles:

```python
# In generate_incremental_daily_digests
for topic in topics:
    digest = {
        'headline': ...,
        'why_it_matters': ...,
        'bullets': ...,
        'article_count': ...,
        # NEW: Individual articles array
        'articles': []
    }
    
    # Query articles for this topic
    articles = get_articles_for_topic(topic, date)
    for article in articles:
        digest['articles'].append({
            'id': article['id'],
            'title': article['title'],
            'url': article['url'],
            'source': article['source'],
            'published_at': article['published_at'],
            'summary': article['summary']
        })
    
    digests[topic] = digest
```

### German Localization Updates

If using German text, update template strings:

```jinja2
## Zusammenfassung

{{ data.executive_summary.headline }}

## Einzelne Artikel

### Statistik

- **Eindeutige Artikel insgesamt:** ...
- **Themen abgedeckt:** ...
- **Bereits berichtete Themen gefiltert:** ...
```

### Testing Approach
1. Generate digest with individual articles
2. Verify each article has title, link, summary
3. Check management summary appears at top
4. Verify German text (if used) is correct
5. Test with 0 articles (edge case)
6. Test with 1 article per topic
7. Test with multiple articles per topic
8. Verify cross-run stats display correctly

### Critical Requirements from Architecture
1. **Individual Output:** Each article gets its own section with link
2. **German Compatibility:** Maintain German localization
3. **Management Summary:** Overview at top remains
4. **Statistics:** Include dedup stats in footer
5. **Backward Compatibility:** Handle missing fields gracefully

## Definition of Done
- [ ] Template modified to output individual articles
- [ ] Each article displays: title, link, summary, source, date
- [ ] Management summary section at top
- [ ] Cross-run dedup statistics in footer
- [ ] German localization maintained (if applicable)
- [ ] Tested with various article counts (0, 1, many)
- [ ] Tested with multiple same-day runs
- [ ] Backward compatibility verified (missing fields don't break)
- [ ] German rating report generation still works
- [ ] Template follows Jinja2 best practices
- [ ] Variables properly escaped for markdown
- [ ] Generated markdown validates correctly

---

## Dev Agent Record

### Agent Model Used
<!-- To be filled by dev agent -->

### Tasks
- [ ] Review existing template structure
- [ ] Modify template to include individual articles section
- [ ] Add article details (title, link, summary, source, date)
- [ ] Add cross-run dedup statistics footer
- [ ] Update digest data structure in enhanced_analyzer.py
- [ ] Test template with sample data
- [ ] Test with edge cases (0 articles, 1 article, many articles)
- [ ] Verify German compatibility
- [ ] Test generated markdown renders correctly

### Debug Log References
<!-- Link to debug log entries if issues encountered -->

### Completion Notes
<!-- Summary of implementation decisions and any deviations from requirements -->

### File List
<!-- List all files created or modified -->
- templates/daily_digest.md.j2 (MODIFIED)
- news_pipeline/enhanced_analyzer.py (MODIFIED - data structure)

### Change Log
<!-- Track changes during development -->

---

**Created:** 2025-10-03
**Last Updated:** 2025-10-03
